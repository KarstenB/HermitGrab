name: Build and Pre-release

on:
  workflow_dispatch: {}
  push:
    branches:
      - 'pre-release' # Trigger on pushes to pre-release branch

jobs:
  create-prerelease:
    runs-on: ubuntu-latest
    permissions: 
      contents: write
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Checkout (GitHub)
        uses: actions/checkout@v3

      - name: Generate Pre-release Tag
        id: tag
        run: |
          python3 << 'EOF'
          import tomllib
          import subprocess
          import sys
          import os
          
          # Read version from Cargo.toml
          with open('Cargo.toml', 'rb') as f:
              data = tomllib.load(f)
          
          version = data.get('package', {}).get('version')
          if not version:
              print("ERROR: Could not find version in Cargo.toml", file=sys.stderr)
              sys.exit(1)
          
          parts = version.split('.')
          if len(parts) != 3:
              print(f"ERROR: Invalid version format: {version}", file=sys.stderr)
              sys.exit(1)
          
          major, minor, patch = parts
          patch = str(int(patch) + 1)
          
          # Get short SHA
          short_sha = subprocess.check_output(['git', 'rev-parse', '--short', 'HEAD']).decode().strip()
          
          tag = f"v{major}.{minor}.{patch}-pre-{short_sha}"
          github_output = os.environ.get('GITHUB_OUTPUT')
          if github_output:
              with open(github_output, "a") as f:
                  f.write(f"tag={tag}\n")
          else:
              print("GITHUB_OUTPUT not set", file=sys.stderr)
              sys.exit(1)
          print(f"Generated tag: {tag}")
          EOF

      - name: Create GitHub Pre-release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          release_name: Pre-release ${{ steps.tag.outputs.tag }}
          draft: false
          prerelease: true
  
  build-linux-win:
    runs-on: ubuntu-latest
    needs: create-prerelease
    permissions: 
      contents: write
    steps:

      - name: Checkout (GitHub)
        uses: actions/checkout@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2 
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and run Dev Container task
        uses: devcontainers/ci@v0.3
        with:
          cacheFrom: ghcr.io/karstenb/hermitgrab-devcontainer
          runCmd: |
            cargo make llvm-cov
            cargo make build-linux-win
            cargo make pkg-linux-win
      
      - name: Upload Linux x86_64 Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-prerelease.outputs.upload_url }}
          asset_path: release/hermitgrab-linux-x86_64.tar.gz
          asset_name: hermitgrab-linux-x86_64.tar.gz
          asset_content_type: application/gzip
  
      - name: Upload Linux aarch64 Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-prerelease.outputs.upload_url }}
          asset_path: release/hermitgrab-linux-aarch64.tar.gz
          asset_name: hermitgrab-linux-aarch64.tar.gz
          asset_content_type: application/gzip
  
      - name: Upload Windows x86_64 Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-prerelease.outputs.upload_url }}
          asset_path: release/hermitgrab-windows-x86_64.zip
          asset_name: hermitgrab-windows-x86_64.zip
          asset_content_type: application/zip
      
      - name: Upload Linux x86_64 Raw Binary
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-prerelease.outputs.upload_url }}
          asset_path: release/hermitgrab-linux-x86_64
          asset_name: hermitgrab-linux-x86_64
          asset_content_type: application/octet-stream

      - name: Upload Linux aarch64 Raw Binary
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-prerelease.outputs.upload_url }}
          asset_path: release/hermitgrab-linux-aarch64
          asset_name: hermitgrab-linux-aarch64
          asset_content_type: application/octet-stream
  
  
  build-macos:
    runs-on: macos-latest # Use a macOS runner for native compilation
    needs: create-prerelease
    permissions: 
      contents: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        target: x86_64-apple-darwin, aarch64-apple-darwin # Build for Intel and Apple Silicon

    - uses: davidB/rust-cargo-make@v1
    - name: Build Release Binaries x86_64
      run: cargo make build-mac-x86_64
    - name: Build Release Binaries aarch64
      run: cargo make build-mac-aarch64
    - name: Package Binaries
      run: cargo make pkg-macos

    - name: Upload Intel Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-prerelease.outputs.upload_url }}
        asset_path: target/x86_64-apple-darwin/release/hermitgrab-macos-x86_64.zip
        asset_name: hermitgrab-macos-x86_64.zip
        asset_content_type: application/zip
    
    - name: Upload Apple Silicon Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-prerelease.outputs.upload_url }}
        asset_path: target/aarch64-apple-darwin/release/hermitgrab-macos-aarch64.zip
        asset_name: hermitgrab-macos-aarch64.zip
        asset_content_type: application/zip

    - name: Upload Intel Raw Binary
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-prerelease.outputs.upload_url }}
        asset_path: target/x86_64-apple-darwin/release/hermitgrab
        asset_name: hermitgrab-macos-x86_64
        asset_content_type: application/octet-stream
    
    - name: Upload Apple Silicon Raw Binary
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-prerelease.outputs.upload_url }}
        asset_path: target/aarch64-apple-darwin/release/hermitgrab
        asset_name: hermitgrab-macos-aarch64
        asset_content_type: application/octet-stream
